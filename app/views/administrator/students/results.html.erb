<div class='modal-header'>
  <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
  <h4 class='modal-title text-center'>Acadamic Results</h4>
  <div class='text-center'>
    <div class="btn-group">
      <%= button_tag 'COPY', type: :button, class: 'clipboard-btn btn btn-primary btn-sm btn-outline', 'data-clipboard-action': 'copy', 'data-clipboard-target': '#results .modal-body' %>
      <%= button_tag 'EXCEL', type: :button, class: 'btn btn-primary btn-sm btn-outline' %>
      <%= button_tag 'PDF', type: :button, class: 'btn btn-primary btn-sm btn-outline' %>
    </div>
  </div>
</div>

<div class='modal-body form-horizontal'>
  <div class='row'>
    <div class='col-sm-12'>
      <table class='table table-bordered'>
        <thead>
          <tr>
            <th>Name</th>
            <th>Roll Number</th>
            <th>Registration Number</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><span class="text-info text-bold"><%= @student.name %></span></td>
            <td><span class="text-info text-bold"><%= @student.roll_number %></span></td>
            <td><span class="text-info text-bold"><%= @student.registration_number %></span></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="row">
    <div class='ibox-content'>
      <div class="full-height-scroll">
        <div class='table-responsive small'>
          <% @sections.each do |section| %>
            <div class="p">
              <div class="panel">
                <table class='table table-striped table-bordered'>
                  <thead>
                    <tr>
                      <th class="result-header">Result</th>
                      <% section.exams.each_with_index do |exam, index| %>
                        <th colspan="6" class="text-center <%= select_result_header_class(index) %>"><%= exam.name %> <small>(<%= exam.percentage %>%) </small></th>
                      <% end %>
                      <th colspan="6" class="text-center">
                        Grand Total
                        <small>(<%= section.exams.collect(&:percentage).sum %> Abs. Marks)</small>
                      </th>
                    </tr>
                    <tr>
                      <th class="result-odd-subheader">Subject</th>
                      <% section.exams.each_with_index do |exam, index| %>
                        <th class="text-center <%= select_result_subheader_class(index) %>">Obtained</th>
                        <th class="text-center <%= select_result_subheader_class(index) %>">Total</th>
                        <th class="text-center <%= select_result_subheader_class(index) %>">Weightage</th>
                        <th class="text-center <%= select_result_subheader_class(index) %>">%</th>
                        <th class="text-center <%= select_result_subheader_class(index) %>">Grade</th>
                        <th class="text-center <%= select_result_subheader_class(index) %>">Highest</th>
                      <% end %>
                      <th class="text-center result-total-row">Abs. Marks</th>
                      <th class="text-center result-total-row">Total</th>
                      <th class="text-center result-total-row">%</th>
                      <th class="text-center result-total-row">Grade</th>
                      <th class="text-center result-total-row">Highest</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% section.subjects.each do |subject| %>
                      <tr>
                        <td class="text-center result-odd-subheader"><%= subject.name %></td>
                        <% section.exams.each do |exam| %>
                          <td class="text-center"><%= @exam_grouped[exam.id].to_a.select{|e| e.subject_id == subject.id}.first.try(:obtained) %></td>
                          <td class="text-center"><%= @exam_grouped[exam.id].to_a.select{|e| e.subject_id == subject.id}.first.try(:total) %></td>
                          <td class="text-center result-percent-row"><%= @exam_grouped[exam.id].to_a.select{|e| e.subject_id == subject.id}.first.try(:actual_obtained) %></td>
                          <td class="text-center"><%= calculate_percentage(@exam_grouped[exam.id].to_a.select{|e| e.subject_id == subject.id}.first.try(:actual_obtained).to_f, exam.percentage.to_f) %></td>
                          <td class="text-center"><%= assign_grade(calculate_percentage(@exam_grouped[exam.id].to_a.select{|e| e.subject_id == subject.id}.first.try(:actual_obtained).to_f, exam.percentage.to_f), @section_grade_mappings[section.id]) %></td>
                          <td class="text-center"><%= exam.exam_marks.where(subject_id: subject.id).pluck(:actual_obtained).max %></td>
                        <% end %>

                        <td class="text-center result-percent-row"><%= @exam_marks.where(subject_id: subject.id).sum(:actual_obtained).to_f %></td>
                        <td class="text-center result-percent-row"><%= section.exams.collect(&:percentage).sum %></td>
                        <td class="text-center result-percent-row"><%= calculate_percentage(@exam_marks.where(subject_id: subject.id).sum(:actual_obtained).to_f, section.exams.collect(&:percentage).sum) %></td>
                        <td class="text-center"><%= assign_grade(calculate_percentage(@exam_marks.where(subject_id: subject.id).sum(:actual_obtained).to_f, section.exams.collect(&:percentage).sum), @section_grade_mappings[section.id]) %></td>
                        <td class="text-center gresult-total-row"><%= section.exam_marks.where(subject_id: subject.id).group(:student_id).sum(:actual_obtained).values.max %></td>
                      </tr>
                    <% end %>
                    <tr>
                      <td class="text-center result-total-row">Total</td>
                      <% section.exams.each do |exam| %>
                        <td class="text-center result-total-row"><%= get_obtained_marks(@exam_grouped[exam.id]) %></td>
                        <td class="text-center result-total-row"><%= get_total_marks(@exam_grouped[exam.id]) %></td>
                        <td class="text-center gresult-total-row"><%= get_actual_marks(@exam_grouped[exam.id]) %></td>
                        <td class="text-center result-total-row"><%= calculate_percentage(get_actual_marks(@exam_grouped[exam.id]), exam.percentage*section.subjects.size) %></td>
                        <td class="text-center"><%= assign_grade(calculate_percentage(get_actual_marks(@exam_grouped[exam.id]), exam.percentage*section.subjects.size), @section_grade_mappings[section.id]) %></td>
                        <td class="text-center result-total-row"><%= exam.exam_marks.group(:student_id).sum(:obtained).values.max  %></td>
                      <% end %>
                      <td class="text-center gresult-total-row gresult-total"><%= @exam_marks.sum(:actual_obtained).to_f %></td>
                      <td class="text-center gresult-total-row gresult-total"><%= section.exams.collect(&:percentage).sum * section.subjects.size %></td>
                      <td class="text-center gresult-total-row gresult-total"><%= calculate_percentage(@exam_marks.sum(:actual_obtained).to_f, section.exams.collect(&:percentage).sum * section.subjects.size) %></td>
                      <td class="text-center"><%= assign_grade(calculate_percentage(@exam_marks.sum(:actual_obtained).to_f, section.exams.collect(&:percentage).sum * section.subjects.size), @section_grade_mappings[section.id]) %></td>
                      <td class="text-center gresult-total-row gresult-total"><%= section.exam_marks.group(:student_id).sum(:actual_obtained).values.max %></td>
                    </tr>
                   </tbody>
                </table>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <div class='clearfix'></div>
</div>

<div class='modal-footer'>
  <div class='col-md-12 text-center'>
    <%= submit_tag 'Print', class: 'btn btn-info' %>
  </div>
</div>
